version: "3.8"

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: fea-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-fea_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-fea_password}
      POSTGRES_DB: ${POSTGRES_DB:-fea_db}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-fea_user}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - fea-network

  # MCP Server (API Server + Database Layer)
  mcp-server:
    build:
      context: .
      dockerfile: services/mcp-server/Dockerfile
    command: sh -c "python init_db.py && uvicorn mcp_server:app --host 0.0.0.0 --port 8000"
    container_name: fea-mcp-server
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-fea_user}:${POSTGRES_PASSWORD:-fea_password}@postgres:5432/${POSTGRES_DB:-fea_db}
      PORT: 8000
    ports:
      - "${MCP_SERVER_PORT:-8000}:8000"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./services/mcp-server:/app
      - ./shared:/app/shared
    networks:
      - fea-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c ''import urllib.request; urllib.request.urlopen("http://localhost:8000/docs")'' || exit 1',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Orchestrator + Streamlit Frontend
  orchestrator:
    build:
      context: .
      dockerfile: services/orchestrator/Dockerfile
    container_name: fea-orchestrator
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      MCP_SERVER_URL: http://mcp-server:8000
    ports:
      - "${ORCHESTRATOR_PORT:-8501}:8501"
    depends_on:
      mcp-server:
        condition: service_healthy
    volumes:
      - ./services/orchestrator:/app
      - ./shared:/app/shared
    networks:
      - fea-network

  # FEA Worker Agent
  fea-worker:
    build:
      context: .
      dockerfile: services/fea-worker/Dockerfile
    container_name: fea-worker
    environment:
      API_BASE_URL: http://mcp-server:8000
      ABAQUS_CMD_PATH: ${ABAQUS_CMD_PATH}
      POLL_INTERVAL_SECONDS: ${POLL_INTERVAL_SECONDS:-5}
    depends_on:
      mcp-server:
        condition: service_healthy
    volumes:
      - ./services/fea-worker:/app
      - ./shared:/app/shared
      - fea_jobs:/app/jobs
    networks:
      - fea-network
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  fea_jobs:
    driver: local

networks:
  fea-network:
    driver: bridge

