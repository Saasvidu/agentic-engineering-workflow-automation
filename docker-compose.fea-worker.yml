version: '3.8'

services:
  abaqus-engine:
    image: abaqusregistry.azurecr.io/abaqus_2024_le:v1
    container_name: abaqus_engine
    platform: linux/amd64
    shm_size: '2gb'
    ports:
      - "6901:6901"
    environment:
      - VNC_PW=password
    volumes:
      - ./shared_data:/home/kasm_user/work
    restart: unless-stopped

  fea-worker:
    build:
      dockerfile: Dockerfile.fea-worker
    container_name: fea_worker
    depends_on:
      - abaqus-engine
    volumes:
      - ./shared_data:/app/jobs
      - /var/run/docker.sock:/var/run/docker.sock # The Bridge
    tty: true
    stdin_open: true
    environment:
      - DOCKER_ENV=true
      - MCP_SERVER_URL=https://mcp-server.yellowtree-5333905a.australiaeast.azurecontainerapps.io
      - ABAQUS_CMD_PATH=abaqus
      - ENGINE_CONTAINER_NAME=abaqus_engine
    restart: on-failure